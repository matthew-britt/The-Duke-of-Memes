{"version":3,"sources":["../../../next-server/server/send-payload.ts"],"names":["sendPayload","req","res","payload","type","generateEtags","options","etag","undefined","headers","statusCode","end","setHeader","Buffer","byteLength","private","stateful","hasHeader","revalidate","Error"],"mappings":"qEACA,mCACA,qEACA,uE,mFAEO,QAASA,CAAAA,WAAT,CACLC,GADK,CAELC,GAFK,CAGLC,OAHK,CAILC,IAJK,CAKLC,aALK,CAMLC,OANK,CAUC,CACN,GAAI,qBAAUJ,GAAV,CAAJ,CAAoB,CAClB,OACD,CAED,KAAMK,CAAAA,IAAI,CAAGF,aAAa,CAAG,kBAAaF,OAAb,CAAH,CAA2BK,SAArD,CAEA,GAAI,mBAAMP,GAAG,CAACQ,OAAV,CAAmB,CAAEF,IAAF,CAAnB,CAAJ,CAAkC,CAChCL,GAAG,CAACQ,UAAJ,CAAiB,GAAjB,CACAR,GAAG,CAACS,GAAJ,GACA,OACD,CAED,GAAIJ,IAAJ,CAAU,CACRL,GAAG,CAACU,SAAJ,CAAc,MAAd,CAAsBL,IAAtB,EACD,CAEDL,GAAG,CAACU,SAAJ,CACE,cADF,CAEER,IAAI,GAAK,MAAT,CAAkB,kBAAlB,CAAuC,0BAFzC,EAIAF,GAAG,CAACU,SAAJ,CAAc,gBAAd,CAAgCC,MAAM,CAACC,UAAP,CAAkBX,OAAlB,CAAhC,EACA,GAAIG,OAAO,EAAI,IAAf,CAAqB,CACnB,GAAIA,OAAO,CAACS,OAAR,EAAmBT,OAAO,CAACU,QAA/B,CAAyC,CACvC,GAAIV,OAAO,CAACS,OAAR,EAAmB,CAACb,GAAG,CAACe,SAAJ,CAAc,eAAd,CAAxB,CAAwD,CACtDf,GAAG,CAACU,SAAJ,CACE,eADF,CAEG,yDAFH,EAID,CACF,CAPD,IAOO,IAAI,MAAON,CAAAA,OAAO,CAACY,UAAf,GAA8B,QAAlC,CAA4C,CACjD,GAAIZ,OAAO,CAACY,UAAR,CAAqB,CAAzB,CAA4B,CAC1B,KAAM,IAAIC,CAAAA,KAAJ,CACH,uDAAsDb,OAAO,CAACY,UAAW,MADtE,CAAN,CAGD,CAEDhB,GAAG,CAACU,SAAJ,CACE,eADF,CAEG,YAAWN,OAAO,CAACY,UAAW,0BAFjC,EAID,CAXM,IAWA,IAAIZ,OAAO,CAACY,UAAR,GAAuB,KAA3B,CAAkC,CACvChB,GAAG,CAACU,SAAJ,CACE,eADF,CAEG,2CAFH,EAID,CACF,CACDV,GAAG,CAACS,GAAJ,CAAQR,OAAR,EACD","sourcesContent":["import { IncomingMessage, ServerResponse } from 'http'\nimport { isResSent } from '../lib/utils'\nimport generateETag from 'next/dist/compiled/etag'\nimport fresh from 'next/dist/compiled/fresh'\n\nexport function sendPayload(\n  req: IncomingMessage,\n  res: ServerResponse,\n  payload: any,\n  type: 'html' | 'json',\n  generateEtags: boolean,\n  options?:\n    | { private: true }\n    | { private: boolean; stateful: true }\n    | { private: boolean; stateful: false; revalidate: number | false }\n): void {\n  if (isResSent(res)) {\n    return\n  }\n\n  const etag = generateEtags ? generateETag(payload) : undefined\n\n  if (fresh(req.headers, { etag })) {\n    res.statusCode = 304\n    res.end()\n    return\n  }\n\n  if (etag) {\n    res.setHeader('ETag', etag)\n  }\n\n  res.setHeader(\n    'Content-Type',\n    type === 'json' ? 'application/json' : 'text/html; charset=utf-8'\n  )\n  res.setHeader('Content-Length', Buffer.byteLength(payload))\n  if (options != null) {\n    if (options.private || options.stateful) {\n      if (options.private || !res.hasHeader('Cache-Control')) {\n        res.setHeader(\n          'Cache-Control',\n          `private, no-cache, no-store, max-age=0, must-revalidate`\n        )\n      }\n    } else if (typeof options.revalidate === 'number') {\n      if (options.revalidate < 1) {\n        throw new Error(\n          `invariant: invalid Cache-Control duration provided: ${options.revalidate} < 1`\n        )\n      }\n\n      res.setHeader(\n        'Cache-Control',\n        `s-maxage=${options.revalidate}, stale-while-revalidate`\n      )\n    } else if (options.revalidate === false) {\n      res.setHeader(\n        'Cache-Control',\n        `s-maxage=31536000, stale-while-revalidate`\n      )\n    }\n  }\n  res.end(payload)\n}\n"]}